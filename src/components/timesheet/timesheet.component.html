
<div class="container mx-auto">
  <div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
    <div>
      <h1 class="text-3xl font-bold">Timesheet</h1>
      <p class="opacity-60 mt-1">Track work hours across projects and clients.</p>
    </div>
  </div>

  <!-- Main Navigation Tabs -->
  <div role="tablist" class="tabs tabs-lifted mb-6">
    <a role="tab" class="tab" [class.tab-active]="activeTab() === 'calendar'" [class.font-bold]="activeTab() === 'calendar'" (click)="activeTab.set('calendar')">Calendar View</a>
    <a role="tab" class="tab" [class.tab-active]="activeTab() === 'history'" [class.font-bold]="activeTab() === 'history'" (click)="activeTab.set('history')">History Log</a>
  </div>

  <!-- VIEW 1: CALENDAR & MOSAIC -->
  @if (activeTab() === 'calendar') {
    <div class="card bg-base-100 shadow mb-8 border border-base-200">
      <div class="card-body">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b border-base-content/10 gap-4">
          <!-- View Switcher -->
          <div role="tablist" class="tabs tabs-boxed bg-base-200">
            <a role="tab" class="tab" [class.tab-active]="viewMode() === 'week'" (click)="viewMode.set('week')">Week</a>
            <a role="tab" class="tab" [class.tab-active]="viewMode() === 'month'" (click)="viewMode.set('month')">Month</a>
          </div>

          <div class="flex items-center gap-4">
            <button (click)="changePeriod(-1)" class="btn btn-ghost btn-circle">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <h2 class="text-xl font-semibold text-center min-w-[180px]">
                @if(viewMode() === 'week') {
                <span>{{ currentWeekDays()[0].date | date:'MMM d' }} - {{ currentWeekDays()[6].date | date:'MMM d, yyyy' }}</span>
                } @else {
                <span>{{ currentDate() | date:'MMMM yyyy' }}</span>
                }
            </h2>
            <button (click)="changePeriod(1)" class="btn btn-ghost btn-circle">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
          </div>
        </div>
        
        <!-- Week View -->
        @if(viewMode() === 'week') {
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-7 gap-4">
            @for(day of currentWeekDays(); track day.name){
              @let summary = getDailySummary(day.date);
              <div (click)="openEntryModal(day.date)" 
                  class="border border-base-content/10 rounded-lg p-3 text-center cursor-pointer hover:bg-base-200 transition-colors min-h-[120px] flex flex-col items-center justify-start relative group bg-base-100">
                <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-primary">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                </div>
                <p class="font-semibold text-xs uppercase tracking-wide opacity-60">{{ day.name }}</p>
                <p class="text-2xl font-bold my-2">{{ day.date.getDate() }}</p>
                
                @if(summary.totalHours > 0){
                  <p class="text-lg font-bold text-primary">{{ summary.totalHours | number:'1.0-1' }}h</p>
                  <p class="text-[10px] opacity-60 mt-1">{{ summary.entries.length }} items</p>
                } @else {
                  <p class="text-base-content/20 mt-2">-</p>
                }
              </div>
            }
          </div>
        }

        <!-- Month View -->
        @if(viewMode() === 'month') {
          <div class="grid grid-cols-7 border border-base-content/10 rounded-lg overflow-hidden bg-base-100">
              @for(dayName of ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']; track dayName){
                <div class="text-center font-semibold text-xs py-2 bg-base-200 border-b border-base-content/10 uppercase tracking-wide opacity-60">{{ dayName }}</div>
              }
              @for(day of currentMonthDays(); track day.date; let i = $index){
                @let summary = getDailySummary(day.date);
                <div (click)="openEntryModal(day.date)" 
                      class="p-2 min-h-[100px] cursor-pointer hover:bg-base-200 transition-colors border-r border-b border-base-content/10 relative group"
                      [class.opacity-40]="!day.isCurrentMonth"
                      [class.bg-base-200]="!day.isCurrentMonth"
                      [class.border-r-0]="(i + 1) % 7 === 0">
                    
                    <div class="flex justify-between items-start">
                      <span class="opacity-0 group-hover:opacity-100 text-primary text-[10px] font-bold">+ Log</span>
                      <p class="font-bold text-sm">{{ day.date.getDate() }}</p>
                    </div>

                    @if(summary.totalHours > 0){
                        <div class="mt-2 flex flex-col gap-1">
                            <div class="p-1 rounded-md bg-primary/10 text-primary text-center">
                                <p class="text-sm font-bold">{{ summary.totalHours | number:'1.0-1' }}h</p>
                            </div>
                        </div>
                    }
                </div>
              }
          </div>
        }
        <div class="mt-4 text-right">
          <p class="text-xs opacity-75">Click on a date to view details or log time.</p>
        </div>
      </div>
    </div>

    <!-- Insights Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Activity Heatmap -->
        <div class="card bg-base-100 shadow border border-base-200 lg:col-span-2">
            <div class="card-body">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="card-title text-base font-bold uppercase tracking-wider opacity-60">Activity Mosaic</h3>
                    <!-- Freelancer Filter -->
                    <select [ngModel]="mosaicMemberFilter()" (ngModelChange)="mosaicMemberFilter.set($any($event))" class="select select-bordered select-xs">
                        <option [ngValue]="null">All Freelancers</option>
                        @for(member of members(); track member.id){
                            <option [ngValue]="member.id">{{ member.name }}</option>
                        }
                    </select>
                </div>
                
                <!-- Mosaic Grid -->
                <div class="grid grid-cols-7 gap-2">
                    <!-- Day Labels -->
                    @for(day of ['M','T','W','T','F','S','S']; track day) {
                        <div class="text-center text-xs opacity-40 font-bold mb-1">{{ day }}</div>
                    }
                    
                    <!-- Cells -->
                    @for(data of periodSummary().heatmap; track data.date.toISOString()) {
                        <div class="aspect-square rounded-md relative group cursor-help transition-colors duration-300"
                            [class]="getHeatmapColor(data.intensity)">
                            
                            <!-- Tooltip -->
                            <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-neutral text-neutral-content text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-20 shadow-lg">
                                <div class="font-bold">{{ data.date | date:'mediumDate' }}</div>
                                <div>{{ data.hours | number:'1.1-1' }} hrs</div>
                            </div>
                        </div>
                    }
                </div>
                
                <!-- Legend -->
                <div class="flex justify-end items-center gap-2 mt-4 text-xs opacity-60">
                    <span>Less</span>
                    <div class="w-3 h-3 bg-base-200 rounded-sm"></div>
                    <div class="w-3 h-3 bg-primary/20 rounded-sm"></div>
                    <div class="w-3 h-3 bg-primary/60 rounded-sm"></div>
                    <div class="w-3 h-3 bg-primary rounded-sm"></div>
                    <span>More</span>
                </div>
            </div>
        </div>

        <!-- User Breakdown Table -->
        <div class="card bg-base-100 shadow border border-base-200 lg:col-span-1">
            <div class="card-body p-0">
                <div class="p-4 border-b border-base-200">
                    <h3 class="font-bold text-base uppercase tracking-wider opacity-60 mb-2">Period Summary</h3>
                    <div class="flex flex-col gap-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm opacity-70">Total Hours</span>
                            <span class="badge badge-neutral font-bold">{{ periodSummary().totalHours | number:'1.1-1' }}h</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm opacity-70">Total Billable</span>
                            <span class="badge badge-primary font-bold">{{ periodSummary().totalEarnings | currency }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr class="bg-base-200/50">
                                <th>Member</th>
                                <th class="text-center">Hours</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for(stat of paginatedUserStats(); track stat.memberId) {
                                <tr>
                                    <td>
                                        <div class="flex items-center gap-2">
                                            <div class="avatar"><div class="w-6 rounded-full"><img [src]="stat.avatarUrl"></div></div>
                                            <div class="flex flex-col">
                                                <span class="font-bold text-xs truncate max-w-[80px]">{{ stat.name }}</span>
                                                <span class="text-[10px] opacity-60">{{ stat.role }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center font-mono">{{ stat.totalHours | number:'1.1-1' }}</td>
                                    <td class="text-right font-medium opacity-80">${{ stat.totalEarnings | number:'1.0-0' }}</td>
                                </tr>
                            } @empty {
                                <tr><td colspan="3" class="text-center py-8 opacity-50 text-xs italic">No hours logged.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                @if(periodSummary().userStats.length > insightsPerPage()) {
                    <div class="p-2 border-t border-base-200 flex justify-center">
                        <app-pagination 
                            [currentPage]="insightsPage()"
                            [totalItems]="periodSummary().userStats.length"
                            [itemsPerPage]="insightsPerPage()"
                            (pageChange)="onInsightsPageChange($event)">
                        </app-pagination>
                    </div>
                }
            </div>
        </div>
    </div>
  }

  <!-- VIEW 2: HISTORY LOG -->
  @if (activeTab() === 'history') {
    <div class="card bg-base-100 shadow border border-base-200">
        <div class="card-body p-0">
            <!-- Filter Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 p-6 border-b border-base-200 bg-base-200/30">
                <div class="form-control">
                    <label class="label py-1"><span class="label-text text-xs font-bold opacity-60 uppercase">Client</span></label>
                    <select [ngModel]="historyClientId()" (ngModelChange)="historyClientId.set($any($event)); historyProjectId.set(null); historyPage.set(1)" class="select select-bordered select-sm w-full">
                        <option [ngValue]="null">All Clients</option>
                        @for(client of clients(); track client.id){
                            <option [ngValue]="client.id">{{ client.name }}</option>
                        }
                    </select>
                </div>
                <div class="form-control">
                    <label class="label py-1"><span class="label-text text-xs font-bold opacity-60 uppercase">Project</span></label>
                    <select [ngModel]="historyProjectId()" (ngModelChange)="historyProjectId.set($any($event)); historyPage.set(1)" class="select select-bordered select-sm w-full" [disabled]="!historyClientId()">
                        <option [ngValue]="null">All Projects</option>
                        @for(project of projectsForHistory(); track project.id){
                            <option [ngValue]="project.id">{{ project.name }}</option>
                        }
                    </select>
                </div>
                <div class="form-control">
                    <label class="label py-1"><span class="label-text text-xs font-bold opacity-60 uppercase">Freelancer</span></label>
                    <select [ngModel]="historyMemberId()" (ngModelChange)="historyMemberId.set($any($event)); historyPage.set(1)" class="select select-bordered select-sm w-full">
                        <option [ngValue]="null">All Freelancers</option>
                        @for(member of members(); track member.id){
                            <option [ngValue]="member.id">{{ member.name }}</option>
                        }
                    </select>
                </div>
                <div class="form-control">
                    <label class="label py-1"><span class="label-text text-xs font-bold opacity-60 uppercase">Start Date</span></label>
                    <input type="date" [ngModel]="historyStartDate()" (ngModelChange)="historyStartDate.set($event); historyPage.set(1)" class="input input-bordered input-sm w-full">
                </div>
                <div class="form-control">
                    <label class="label py-1"><span class="label-text text-xs font-bold opacity-60 uppercase">End Date</span></label>
                    <div class="flex gap-2">
                        <input type="date" [ngModel]="historyEndDate()" (ngModelChange)="historyEndDate.set($event); historyPage.set(1)" class="input input-bordered input-sm w-full">
                        <button class="btn btn-ghost btn-sm" (click)="resetHistoryFilters()">Reset</button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead class="bg-base-100 text-base-content/70">
                        <tr>
                            <th class="pl-6">Date</th>
                            <th>Freelancer</th>
                            <th>Project / Client</th>
                            <th>Description</th>
                            <th class="text-center">Hours</th>
                            <th class="text-right pr-6">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for(entry of paginatedHistory(); track entry.id) {
                            <tr class="hover:bg-base-100 group">
                                <td class="pl-6 text-sm font-medium">{{ entry.date | date:'mediumDate' }}</td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <div class="avatar"><div class="w-6 rounded-full"><img [src]="entry.memberAvatarUrl"></div></div>
                                        <span class="text-sm">{{ entry.memberName }}</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="text-sm font-bold">{{ entry.projectName }}</div>
                                    <div class="text-xs opacity-50">{{ entry.clientName }}</div>
                                </td>
                                <td class="text-sm max-w-xs truncate opacity-80" [title]="entry.description">{{ entry.description }}</td>
                                <td class="text-center font-mono font-bold text-primary">{{ entry.hours }}</td>
                                <td class="text-right pr-6">
                                    <button class="btn btn-ghost btn-xs text-error opacity-0 group-hover:opacity-100 transition-opacity" (click)="deleteEntry(entry.projectId, entry.weekId, entry.dayName)">Delete</button>
                                </td>
                            </tr>
                        } @empty {
                            <tr><td colspan="6" class="text-center py-12 opacity-50 italic">No history entries found.</td></tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            @if(filteredHistory().length > historyPerPage()) {
                <div class="p-4 flex justify-center border-t border-base-200">
                    <app-pagination 
                        [currentPage]="historyPage()" 
                        [totalItems]="filteredHistory().length" 
                        [itemsPerPage]="historyPerPage()" 
                        (pageChange)="onHistoryPageChange($event)">
                    </app-pagination>
                </div>
            }
        </div>
    </div>
  }
</div>

<!-- Time Entry Modal -->
@if(isEntryModalOpen() && entryModalDate(); as date){
  <div class="modal modal-open" role="dialog" (click)="closeEntryModal()">
    <div class="modal-box w-11/12 max-w-3xl shadow-2xl" (click)="$event.stopPropagation()">
      <button (click)="closeEntryModal()" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
      <h3 class="font-bold text-xl mb-1">Log Time</h3>
      <p class="opacity-60 mb-6">{{ date | date:'fullDate' }}</p>

      <div class="flex flex-col md:flex-row gap-8">
        <!-- Left: Entry Form -->
        <form (ngSubmit)="saveTimeEntry()" class="flex-1 space-y-4">
          <div class="form-control">
             <label class="label"><span class="label-text font-medium">Freelancer</span></label>
             <select [ngModel]="modalMemberId()" (ngModelChange)="modalMemberId.set(+$event)" name="member" class="select select-bordered w-full" [disabled]="!isAdmin()" required>
                <option [ngValue]="null" disabled>Select Member</option>
                @for(member of members(); track member.id){
                  <option [value]="member.id">{{ member.name }}</option>
                }
             </select>
          </div>
          
          <div class="form-control">
            <label class="label"><span class="label-text font-medium">Client</span></label>
            <select [ngModel]="modalClientId()" (ngModelChange)="modalClientId.set(+$event); modalProjectId.set(null)" name="client" class="select select-bordered w-full" required>
               <option [ngValue]="null" disabled>Select Client</option>
               @for(client of clients(); track client.id){
                 <option [value]="client.id">{{ client.name }}</option>
               }
            </select>
          </div>

          <div class="form-control">
            <label class="label"><span class="label-text font-medium">Project</span></label>
            <select [ngModel]="modalProjectId()" (ngModelChange)="modalProjectId.set(+$event)" name="project" class="select select-bordered w-full" [disabled]="!modalClientId()" required>
               <option [ngValue]="null" disabled>Select Project</option>
               @for(project of modalAvailableProjects(); track project.id){
                 <option [value]="project.id">{{ project.name }}</option>
               }
            </select>
            @if(modalClientId() && modalAvailableProjects().length === 0) {
                 <div class="text-xs text-warning mt-1">No active hourly projects available for this client.</div>
            }
          </div>

          <div class="grid grid-cols-3 gap-4">
              <div class="form-control col-span-1">
                <label class="label"><span class="label-text font-medium">Hours</span></label>
                <input type="number" [ngModel]="entryHours()" (ngModelChange)="entryHours.set($event)" name="hours" required min="0.25" max="24" step="0.25" class="input input-bordered">
              </div>
          </div>

          <div class="form-control">
            <label class="label"><span class="label-text font-medium">Description</span></label>
            <textarea [ngModel]="entryDescription()" (ngModelChange)="entryDescription.set($event)" name="description" rows="3" class="textarea textarea-bordered" placeholder="What did you work on?"></textarea>
          </div>

          <div class="modal-action pt-4">
            <button type="button" (click)="closeEntryModal()" class="btn btn-ghost">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="!modalMemberId() || !modalProjectId() || entryHours() <= 0">Save Entry</button>
          </div>
        </form>

        <!-- Right: Existing Entries Summary (Grouped by Freelancer) -->
        <div class="w-full md:w-1/3 border-l border-base-200 pl-0 md:pl-6 pt-6 md:pt-0">
            <h4 class="font-bold text-sm uppercase tracking-wider opacity-60 mb-4">Entries for this day</h4>
            
            @if(groupedModalEntries().length > 0) {
                <div class="space-y-4 max-h-[400px] overflow-y-auto custom-scrollbar pr-2">
                    @for(group of groupedModalEntries(); track group.memberId) {
                        <div class="bg-base-200/30 rounded-xl p-3 border border-base-200">
                            <!-- Group Header -->
                            <div class="flex items-center gap-2 mb-3 pb-2 border-b border-base-200">
                                <div class="avatar"><div class="w-6 rounded-full"><img [src]="group.avatarUrl"></div></div>
                                <span class="font-bold text-sm">{{ group.memberName }}</span>
                            </div>

                            <!-- Entries -->
                            <div class="space-y-2">
                                @for(entry of group.entries; track $index) {
                                    <div class="text-xs relative group/entry">
                                        <button (click)="deleteEntry(entry.projectId)" class="absolute right-0 top-0 text-error opacity-0 group-hover/entry:opacity-100 transition-opacity hover:bg-error/10 rounded p-0.5" title="Delete">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                        </button>
                                        <div class="font-medium text-base-content/80 pr-4">{{ entry.projectName }}</div>
                                        <div class="flex justify-between mt-0.5">
                                            <span class="opacity-60 truncate max-w-[120px]">{{ entry.description }}</span>
                                            <span class="font-bold text-primary">{{ entry.hours }}h</span>
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Group Total -->
                            <div class="mt-3 pt-2 border-t border-base-200 flex justify-between text-xs font-bold">
                                <span>Total</span>
                                <span>{{ group.totalHours }}h</span>
                            </div>
                        </div>
                    }
                </div>
            } @else {
                <div class="text-center py-10 opacity-50 text-sm italic bg-base-200/30 rounded-lg">
                    No time logged yet.
                </div>
            }
        </div>
      </div>
    </div>
  </div>
}
