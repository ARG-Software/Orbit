
<!-- Full Width Fixed Header -->
<header class="navbar bg-base-100 fixed top-0 left-0 right-0 z-50 p-0 h-16 border-b border-base-200">
  
  <!-- DESKTOP SIDEBAR HEADER (Matches Sidebar Width) -->
  <div class="hidden lg:flex items-center h-full border-r border-base-200 transition-all duration-300 bg-base-100 shrink-0"
       [class.w-64]="!isSidebarCollapsed()"
       [class.w-20]="isSidebarCollapsed()"
       [class.justify-between]="!isSidebarCollapsed()"
       [class.justify-center]="isSidebarCollapsed()"
       [class.px-6]="!isSidebarCollapsed()"
       [class.px-0]="isSidebarCollapsed()">
       
       <!-- Logo (Visible when Expanded) -->
       @if(!isSidebarCollapsed()) {
           <a routerLink="/app/dashboard" class="flex items-center gap-3 hover:opacity-80 transition-opacity overflow-hidden whitespace-nowrap min-w-0">
              <!-- Logo Icon -->
              <div data-theme="pastel" class="w-9 h-9 flex items-center justify-center rounded-xl bg-gradient-to-tr from-primary to-secondary shadow-lg shadow-primary/20 text-primary-content shrink-0">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5">
                  <path d="M12 21a9 9 0 1 0-9-9c0 1.48.36 2.88.99 4.12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" class="opacity-90"/>
                  <circle cx="12" cy="12" r="3.5" class="fill-current"/>
                  <circle cx="20.4" cy="8.6" r="2.5" class="fill-accent stroke-none"/>
                </svg>
              </div>
              
              <!-- Text Label -->
              <span class="text-xl font-bold tracking-tight text-base-content truncate transition-opacity duration-300">Orbit</span>
           </a>
       }

       <!-- Sidebar Toggle Button -->
       <button (click)="toggleSidebar()" class="btn btn-ghost btn-sm btn-square shrink-0 opacity-50 hover:opacity-100" [title]="isSidebarCollapsed() ? 'Expand' : 'Collapse'">
            @if(isSidebarCollapsed()) {
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
            } @else {
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" /></svg>
            }
       </button>
  </div>

  <!-- MAIN TOOLBAR -->
  <div class="flex-1 flex justify-between items-center px-4 sm:px-6 h-full">
    <!-- Left: Mobile Toggle -->
    <div class="flex items-center gap-3 lg:hidden">
        <label for="mobile-drawer" class="btn btn-ghost btn-circle">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
        </label>
        <span class="text-lg font-bold tracking-tight text-base-content">Orbit</span>
    </div>

    <!-- Right: Search & Actions -->
    <div class="flex flex-1 justify-end items-center gap-2 sm:gap-4 ml-auto">
        <!-- Quick Search -->
        <div class="form-control hidden sm:block relative">
            <input 
                type="text" 
                [placeholder]="translationService.translate('Jump to...')" 
                class="input input-bordered w-32 md:w-48 h-10 transition-all focus:w-64 input-sm rounded-lg"
                [ngModel]="searchQuery()"
                (ngModelChange)="searchQuery.set($event)"
                (keyup.enter)="onSearchEnter()"
                (keyup.escape)="searchQuery.set('')"
            />
            
            @if(filteredPages().length > 0) {
                <ul class="absolute top-12 right-0 w-64 menu bg-base-100 rounded-xl shadow-xl border border-base-200 z-50 p-2">
                    <li class="menu-title px-2 py-1 text-xs opacity-50">Pages</li>
                    @for(page of filteredPages(); track page.path) {
                        <li><a (click)="navigateTo(page.path)" class="flex justify-between items-center py-2 hover:bg-base-200"><span class="font-medium">{{ page.name }}</span></a></li>
                    }
                </ul>
            }
        </div>

        <!-- Language Selector -->
        <div class="dropdown dropdown-end">
          <button tabindex="0" class="btn btn-ghost btn-sm font-normal px-2">
            {{ translationService.currentLang() === 'en' ? 'ðŸ‡ºðŸ‡¸ EN' : 'ðŸ‡µðŸ‡¹ PT' }}
          </button>
          <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-100 rounded-xl w-32 border border-base-200 mt-2">
            <li><a (click)="translationService.setLanguage('en')" [class.active]="translationService.currentLang() === 'en'">English</a></li>
            <li><a (click)="translationService.setLanguage('pt')" [class.active]="translationService.currentLang() === 'pt'">PortuguÃªs</a></li>
          </ul>
        </div>

        <!-- Theme Toggle -->
        <label class="swap swap-rotate btn btn-ghost btn-circle text-base-content/70 hover:text-base-content">
          <input type="checkbox" [checked]="isDarkMode()" (change)="toggleTheme($event)" />
          <svg class="swap-off fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,5.64,7.05Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
          <svg class="swap-on fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/></svg>
        </label>

        <!-- User Avatar -->
        <div class="dropdown dropdown-end" (mouseleave)="closeUserDropdown()">
          <label tabindex="0" class="btn btn-ghost btn-circle avatar">
             <div class="w-9 rounded-full ring ring-base-300 ring-offset-base-100 ring-offset-2">
               <img [src]="user()?.logoUrl || 'https://picsum.photos/seed/user/40/40'" alt="User" class="object-cover">
             </div>
          </label>
           <ul tabindex="0" class="menu menu-sm dropdown-content mt-0 z-[1] p-2 shadow-lg bg-base-100 rounded-box w-52 border border-base-200">
             <li class="px-2 py-1 text-xs opacity-50 font-bold uppercase">{{ user()?.role }}</li>
             <li><a routerLink="/app/settings" class="py-2">{{ translationService.translate('Settings') }}</a></li>
             <div class="divider my-1"></div>
             <li><a (click)="logout()" class="py-2 text-error">{{ translationService.translate('Sign Out') }}</a></li>
           </ul>
        </div>
    </div>
  </div>
</header>

<!-- Main Layout Container -->
<div class="drawer lg:drawer-open min-h-screen">
	<input id="mobile-drawer" type="checkbox" class="drawer-toggle" [checked]="isMobileMenuOpen()" (change)="toggleMobileMenu()" />
	
  <!-- Content -->
  <div class="drawer-content flex flex-col pt-16">
		<main [class]="mainBackgroundClass()" [ngStyle]="backgroundStyle()">
      <!-- Module Accent Bar -->
      @if (moduleAccentColor() !== 'transparent') {
        <div class="w-full h-[0.05rem]" [style.background-color]="moduleAccentColor()"></div>
      }

      <!-- Main Router Outlet -->
      <div class="w-full px-4 sm:px-6 lg:px-8 py-6">
        <router-outlet></router-outlet>
      </div>
    </main>
	</div>
  
  <!-- Sidebar -->
	<div class="drawer-side z-40" style="top: 4rem; height: calc(100vh - 4rem);">
		<label for="mobile-drawer" class="drawer-overlay"></label>
    
    <div class="bg-base-100 flex flex-col border-r border-base-200 h-full transition-all duration-300"
         [class.w-64]="!isSidebarCollapsed()"
         [class.w-20]="isSidebarCollapsed()">
        
        <!-- SIDEBAR NAVIGATION -->
        <div class="flex-1 overflow-y-auto py-6 px-4 space-y-1">
            @for(item of navGroups(); track item.label || item.name) {
                
                <!-- SINGLE LINK -->
                @if(item.type === 'link') {
                    <a [routerLink]="'/app/' + item.path" 
                       routerLinkActive="bg-base-200 font-bold text-base-content shadow-sm" 
                       [routerLinkActiveOptions]="{exact: false}"
                       (click)="toggleMobileMenu()"
                       class="group flex items-center justify-between px-3 py-2.5 rounded-xl text-base font-medium text-base-content hover:bg-base-100 hover:text-base-content transition-all duration-200 cursor-pointer mb-1"
                       [title]="!showLabels() ? item.name : ''">
                        
                        <div class="flex items-center gap-3 min-w-0">
                            <!-- Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 opacity-100 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" [attr.d]="item.icon" />
                            </svg>
                            <!-- Label -->
                            @if(showLabels()) {
                                <span class="truncate">{{ item.name }}</span>
                            }
                        </div>

                        <!-- Right Side: Badge & Actions -->
                        @if(showLabels()) {
                            <div class="flex items-center gap-2">
                                @if(item.isPinned) {
                                    <button class="btn btn-xs btn-circle btn-ghost text-warning opacity-0 group-hover:opacity-100 transition-opacity" (click)="$event.preventDefault(); $event.stopPropagation(); unpinProject(item.id)">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 fill-current" viewBox="0 0 24 24"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                                    </button>
                                }
                                @if(item.badge) {
                                    <span class="badge badge-sm rounded-md font-medium border-0" 
                                          [class.bg-emerald-100]="!item.badgeColor" [class.text-emerald-700]="!item.badgeColor"
                                          [class.bg-orange-100]="item.badgeColor === 'warning'" [class.text-orange-700]="item.badgeColor === 'warning'">
                                        {{ item.badge }}
                                    </span>
                                }
                            </div>
                        }
                    </a>
                }

                <!-- GROUP (Accordion) -->
                @if(item.type === 'group') {
                    <details class="group/acc mb-1" [open]="true">
                        <summary class="flex items-center justify-between px-3 py-2.5 rounded-xl text-base font-semibold text-base-content hover:bg-base-100 hover:text-base-content transition-colors cursor-pointer list-none [&::-webkit-details-marker]:hidden mb-1">
                            <div class="flex items-center gap-3 min-w-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 opacity-100" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" [attr.d]="item.icon" />
                                </svg>
                                @if(showLabels()) {
                                    <span class="truncate">{{ item.label }}</span>
                                }
                            </div>
                            @if(showLabels()) {
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform duration-200 group-open/acc:rotate-180 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                </svg>
                            }
                        </summary>
                        
                        @if(showLabels() && item.children) {
                            <div class="relative ml-5 pl-3 border-l-2 border-base-300 space-y-0.5">
                                @for(child of item.children; track child.name) {
                                    
                                    <!-- Nested Group (Level 2) -->
                                    @if(child.children) {
                                        <details class="group/sub" [open]="true">
                                            <summary class="flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium text-base-content/90 hover:text-base-content hover:bg-base-100 transition-all cursor-pointer list-none">
                                                <div class="flex items-center gap-2">
                                                    @if(child.icon) {
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0 opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" [attr.d]="child.icon" /></svg>
                                                    }
                                                    <span>{{ child.name }}</span>
                                                </div>
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 transition-transform duration-200 group-open/sub:rotate-90 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                                            </summary>
                                            <div class="ml-2 pl-2 border-l-2 border-base-300 mt-0.5 space-y-0.5">
                                                @for(sub of child.children; track sub.path) {
                                                    <a [routerLink]="'/app/' + sub.path" 
                                                       routerLinkActive="bg-base-200 text-base-content font-bold"
                                                       class="flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium text-base-content/90 hover:text-base-content hover:bg-base-100 transition-all">
                                                        <span>{{ sub.name }}</span>
                                                    </a>
                                                }
                                            </div>
                                        </details>
                                    } 
                                    <!-- Nested Link (Level 1) -->
                                    @else {
                                        <a [routerLink]="'/app/' + child.path" 
                                           routerLinkActive="bg-base-200 text-base-content font-bold"
                                           class="group/link flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium text-base-content/90 hover:text-base-content hover:bg-base-100 transition-all">
                                            <div class="flex items-center gap-2">
                                                @if(child.icon) {
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0 opacity-80 group-hover/link:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" [attr.d]="child.icon" /></svg>
                                                }
                                                <span>{{ child.name }}</span>
                                            </div>
                                            
                                            <!-- Child Badges -->
                                            <div class="flex items-center gap-2">
                                                @if(child.isPinned) {
                                                    <button class="btn btn-xs btn-circle btn-ghost text-warning opacity-0 group-hover/link:opacity-100 transition-opacity" (click)="$event.preventDefault(); $event.stopPropagation(); unpinProject(child.id)">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 fill-current" viewBox="0 0 24 24"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                                                    </button>
                                                }
                                                @if(child.badge) {
                                                    <span class="badge badge-sm rounded-md font-medium border-0 px-1.5 h-5 min-h-0 text-[10px]" 
                                                          [class.bg-emerald-100]="!child.badgeColor" [class.text-emerald-700]="!child.badgeColor"
                                                          [class.bg-orange-100]="child.badgeColor === 'warning'" [class.text-orange-700]="child.badgeColor === 'warning'">
                                                        {{ child.badge }}
                                                    </span>
                                                }
                                            </div>
                                        </a>
                                    }
                                }
                            </div>
                        }
                    </details>
                }
            }
        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-base-200">
            <button (click)="logout()" class="w-full flex items-center justify-center gap-2 btn btn-ghost btn-sm text-base-content hover:bg-base-200 hover:text-base-content rounded-xl font-medium transition-all" [class.btn-square]="!showLabels()" [title]="!showLabels() ? translationService.translate('Sign Out') : ''">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                @if(showLabels()) {
                    <span class="text-base">{{ translationService.translate('Sign Out') }}</span>
                }
            </button>
        </div>
    </div>
	</div>
</div>
