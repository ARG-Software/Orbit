
@if(project(); as p) {
<div class="container mx-auto pb-4 h-full flex flex-col">
  
  <!-- Header -->
  <div class="mb-6 shrink-0">
      <div class="flex items-center gap-3 mb-2 text-xs font-bold uppercase opacity-40 tracking-wider">
          <a routerLink="/app/projects" class="hover:text-primary">Projects</a>
          <span>/</span>
          <span>{{ getClient(p.clientId)?.name }}</span>
      </div>
      
      <div class="flex flex-col lg:flex-row gap-6 items-start">
          <div class="flex-1">
              <div class="flex items-center gap-4 mb-2">
                  <h1 class="text-4xl font-light tracking-tight">{{ p.name }}</h1>
                  <span class="badge badge-md font-bold border-base-200" 
                    [class.badge-neutral]="p.status === 'Active'"
                    [class.bg-base-100]="p.status !== 'Active'">
                    {{ p.status }}
                  </span>
                  <button class="btn btn-circle btn-ghost btn-xs" (click)="togglePin()" [title]="p.isPinned ? 'Unpin Project' : 'Pin to Sidebar'">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" [class.fill-current]="p.isPinned" [class.text-warning]="p.isPinned" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                  </button>
              </div>
              <p class="text-sm opacity-60 leading-relaxed max-w-3xl">
                  {{ p.description || 'No description provided for this project.' }}
              </p>
          </div>
          
          <div class="flex flex-wrap gap-2 shrink-0">
              <button class="btn btn-sm btn-ghost text-error hover:bg-error/10" (click)="deleteProject()">
                  Delete
              </button>
          </div>
      </div>
  </div>

  <!-- Navigation Tabs -->
  <div role="tablist" class="tabs tabs-lifted z-10 relative shrink-0">
    <a role="tab" class="tab" [class.tab-active]="activeTab() === 'overview'" (click)="activeTab.set('overview')">Overview</a>
    <a role="tab" class="tab" [class.tab-active]="activeTab() === 'wiki'" (click)="activeTab.set('wiki')">Wiki</a>
    <a role="tab" class="tab" [class.tab-active]="activeTab() === 'tasks'" (click)="activeTab.set('tasks')">Tasks</a>
    <a role="tab" class="tab" [class.tab-active]="activeTab() === 'files'" (click)="activeTab.set('files')">Files</a>
    <a role="tab" class="tab" [class.tab-active]="activeTab() === 'team'" (click)="activeTab.set('team')">Team</a>
    <a role="tab" class="tab" [class.tab-active]="activeTab() === 'chat'" (click)="activeTab.set('chat')">Chat</a>
  </div>

  <!-- Unified Content Container -->
  <div class="bg-base-100 shadow-sm border border-base-200 rounded-b-lg rounded-tr-lg rounded-tl-none -mt-px p-6 flex-1 flex flex-col min-h-0 overflow-hidden">
      
      <!-- TAB: OVERVIEW -->
      @if(activeTab() === 'overview') {
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto pr-2">
              <div class="lg:col-span-2 space-y-6">
                  
                  <!-- Financial Cards -->
                  @let fin = projectFinancials();
                  <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                      <!-- Project Rate/Value Card -->
                      <div class="card bg-base-100 shadow-sm border border-base-200 rounded-lg p-5">
                          <div class="font-bold text-xs uppercase tracking-wider opacity-50 mb-2">Project Value</div>
                          @if(p.billingType === 'fixed') {
                              <div class="text-2xl font-light tracking-tight">{{ p.fixedPrice | currency:'USD':'symbol':'1.0-0' }}</div>
                              <div class="text-[10px] opacity-50 mt-1">Fixed Price</div>
                          } @else {
                              <div class="text-2xl font-light tracking-tight">{{ p.defaultRate | currency }}</div>
                              <div class="text-[10px] opacity-50 mt-1">Hourly Rate</div>
                          }
                      </div>

                      <div class="card bg-base-100 shadow-sm border border-base-200 rounded-lg p-5">
                          <div class="font-bold text-xs uppercase tracking-wider opacity-50 mb-2">Total Income</div>
                          <div class="text-2xl font-light tracking-tight text-success">{{ fin.income | currency:'USD':'symbol':'1.0-0' }}</div>
                          <div class="text-[10px] opacity-50 mt-1">Generated</div>
                      </div>
                      <div class="card bg-base-100 shadow-sm border border-base-200 rounded-lg p-5">
                          <div class="font-bold text-xs uppercase tracking-wider opacity-50 mb-2">Expenses</div>
                          <div class="text-2xl font-light tracking-tight text-error">{{ fin.expense | currency:'USD':'symbol':'1.0-0' }}</div>
                          <div class="text-[10px] opacity-50 mt-1">Team Costs</div>
                      </div>
                      <div class="card bg-base-100 shadow-sm border border-base-200 rounded-lg p-5">
                          <div class="font-bold text-xs uppercase tracking-wider opacity-50 mb-2">Profit</div>
                          <div class="text-2xl font-light tracking-tight">{{ fin.profit | currency:'USD':'symbol':'1.0-0' }}</div>
                          <div class="text-[10px] font-bold text-success mt-1">{{ fin.profitMargin | number:'1.0-1' }}% Margin</div>
                      </div>
                  </div>

                  <!-- D3 CHART -->
                  <div class="card bg-base-100 shadow-sm border border-base-200 rounded-lg">
                      <div class="card-body p-6">
                          <div class="flex justify-between items-center mb-6">
                              <h3 class="font-bold text-sm uppercase tracking-wider opacity-60">Financial Trajectory</h3>
                              <div class="flex gap-4 text-xs font-bold uppercase">
                                  <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-success"></span> Revenue</div>
                                  <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-error"></span> Expense</div>
                              </div>
                          </div>
                          <div class="w-full h-64 relative">
                              @if(financialChartPaths(); as chart) {
                                  <svg [attr.viewBox]="'0 0 ' + chartWidth + ' ' + chartHeight" preserveAspectRatio="none" class="w-full h-full overflow-visible">
                                      <defs>
                                          <linearGradient id="gradExpense" x1="0" x2="0" y1="0" y2="1">
                                              <stop offset="0%" stop-color="#ff5861" stop-opacity="0.1"/>
                                              <stop offset="100%" stop-color="#ff5861" stop-opacity="0"/>
                                          </linearGradient>
                                      </defs>
                                      <path [attr.d]="chart.expenseAreaD" fill="url(#gradExpense)" />
                                      <path [attr.d]="chart.revenueD" fill="none" stroke="#00a96e" stroke-width="2" stroke-linecap="round" />
                                      <path [attr.d]="chart.expenseD" fill="none" stroke="#ff5861" stroke-width="2" stroke-linecap="round" />
                                  </svg>
                              } @else {
                                  <div class="flex items-center justify-center h-full opacity-40 text-sm">Not enough data to graph</div>
                              }
                          </div>
                      </div>
                  </div>

                  <!-- Team Costs List -->
                  <div class="divider text-xs uppercase opacity-30 font-bold tracking-widest">Team Performance</div>
                  <div class="card bg-base-100 shadow-sm border border-base-200 rounded-lg">
                      <div class="card-body p-0">
                          <div class="overflow-x-auto">
                              <table class="table table-sm">
                                  <thead class="bg-base-50/50">
                                      <tr>
                                          <th class="pl-6 font-medium text-xs opacity-60 uppercase">Member</th>
                                          <th class="text-right font-medium text-xs opacity-60 uppercase">Hours</th>
                                          <th class="text-right font-medium text-xs opacity-60 uppercase">Revenue</th>
                                          <th class="text-right font-medium text-xs opacity-60 uppercase">Cost</th>
                                          <th class="text-right pr-6 font-medium text-xs opacity-60 uppercase">Action</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      @for(u of userCostBreakdown(); track u.member.id) {
                                          <tr class="hover:bg-base-50">
                                              <td class="pl-6">
                                                  <div class="flex items-center gap-3">
                                                      <div class="avatar">
                                                          <div class="w-8 h-8 rounded-full ring-1 ring-base-200">
                                                              <img [src]="u.member.avatarUrl" />
                                                          </div>
                                                      </div>
                                                      <div>
                                                          <div class="font-bold text-sm">{{ u.member.name }}</div>
                                                          @if(u.member.role === 'Founder' || u.member.role === 'Admin') {
                                                              <div class="text-[10px] opacity-50">Admin</div>
                                                          }
                                                      </div>
                                                  </div>
                                              </td>
                                              <td class="text-right font-mono text-sm">{{ u.hours | number:'1.1-1' }}h</td>
                                              <td class="text-right font-mono font-medium text-success">{{ u.revenue | currency:'USD':'symbol':'1.0-0' }}</td>
                                              <td class="text-right font-mono font-bold" [class.text-error]="u.cost > 0">{{ u.cost | currency:'USD':'symbol':'1.0-0' }}</td>
                                              <td class="text-right pr-6">
                                                  @if(u.cost > 0) {
                                                      <button class="btn btn-xs btn-neutral btn-outline" (click)="openPaymentModal(u.member.id, u.cost)">Pay</button>
                                                  } @else {
                                                      <span class="text-xs opacity-40 italic">--</span>
                                                  }
                                              </td>
                                          </tr>
                                      } @empty {
                                          <tr><td colspan="5" class="text-center opacity-50 italic py-6 text-sm">No hours logged yet.</td></tr>
                                      }
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- Right Column -->
              <div class="space-y-6">
                  <div class="card bg-base-100 shadow-sm border border-base-200 rounded-lg">
                      <div class="card-body p-6">
                          <h3 class="font-bold text-xs uppercase tracking-wider opacity-60 mb-4">Completion</h3>
                          @if(projectStats(); as stats) {
                              <div class="radial-progress text-base-content/80 mx-auto my-4" style="--value:{{stats.progress}}; --size:8rem; --thickness: 6px;" role="progressbar">
                                  <span class="text-xl font-light">{{ stats.progress | number:'1.0-0' }}%</span>
                              </div>
                              <div class="flex justify-between text-xs opacity-60 mt-2 border-t border-base-200 pt-3">
                                  <span>Completed</span>
                                  <span class="font-bold">{{ stats.completedTasks }} / {{ stats.totalTasks }} Tasks</span>
                              </div>
                          }
                      </div>
                  </div>

                  <div class="card bg-base-100 shadow-sm border border-base-200 rounded-lg">
                      <div class="card-body p-0">
                          <div class="p-4 border-b border-base-200 font-bold text-xs uppercase tracking-wider opacity-60">Recent Activity</div>
                          <div class="divide-y divide-base-100">
                              @for(item of recentActivity(); track $index) {
                                  <div class="p-4 flex items-start gap-3 hover:bg-base-50 transition-colors">
                                      <div class="mt-1.5">
                                          @if(item.type === 'file') { <div class="w-1.5 h-1.5 rounded-full bg-info"></div> } 
                                          @else { <div class="w-1.5 h-1.5 rounded-full bg-warning"></div> }
                                      </div>
                                      <div>
                                          <div class="text-sm font-medium">{{ item.label }}</div>
                                          <div class="text-[10px] opacity-40 font-bold uppercase tracking-wide mt-0.5">{{ item.date | date:'mediumDate' }}</div>
                                      </div>
                                  </div>
                              } @empty {
                                  <div class="p-6 text-center opacity-50 text-sm">No recent activity.</div>
                              }
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      }

      <!-- TAB: TEAM CHAT (Modern Bubbles) -->
      @if(activeTab() === 'chat') {
          <div class="flex flex-col h-full bg-base-50 rounded-lg overflow-hidden border border-base-200">
              <!-- Chat Header -->
              <div class="bg-base-100 border-b border-base-200 p-4 flex justify-between items-center shrink-0">
                  <div>
                      <h3 class="font-bold text-sm">Team Chat</h3>
                      <p class="text-xs opacity-50">#{{ p.name.replace(' ', '-').toLowerCase() }}</p>
                  </div>
                  <div class="avatar-group -space-x-2">
                      @for(m of regularMembers().slice(0,3); track m.id) {
                          <div class="avatar border-base-100"><div class="w-8"><img [src]="m.avatarUrl"></div></div>
                      }
                  </div>
              </div>
              
              <!-- Chat Messages Area -->
              <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                  @for(msg of chatMessages(); track msg.id) {
                      <div class="chat" [ngClass]="msg.isMe ? 'chat-end' : 'chat-start'">
                          <div class="chat-image avatar">
                              <div class="w-8 rounded-full border border-base-200">
                                  <img [alt]="msg.senderName" [src]="msg.senderAvatar" />
                              </div>
                          </div>
                          <div class="chat-header text-[10px] opacity-40 mb-1 font-bold uppercase tracking-wide">
                              {{ msg.senderName }}
                              <time class="ml-1 font-normal">{{ msg.timestamp | date:'shortTime' }}</time>
                          </div>
                          <!-- Updated Bubble Color -->
                          <div class="chat-bubble text-sm shadow-sm" [ngClass]="msg.isMe ? 'bg-base-content text-base-100' : 'bg-base-100 text-base-content border border-base-200'">{{ msg.text }}</div>
                      </div>
                  }
              </div>
              
              <!-- Input Area -->
              <div class="bg-base-100 p-4 border-t border-base-200 shrink-0">
                  <form (ngSubmit)="sendMessage()" class="flex gap-2">
                      <input type="text" [ngModel]="chatInput()" (ngModelChange)="chatInput.set($event)" name="chatInput" class="input input-bordered w-full rounded-md focus:input-primary" placeholder="Type a message..." autocomplete="off">
                      <button type="submit" class="btn btn-square btn-neutral rounded-md" [disabled]="!chatInput()">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>
                      </button>
                  </form>
              </div>
          </div>
      }

      <!-- TAB: WIKI (Specifics) -->
      @if(activeTab() === 'wiki') {
          <div class="flex flex-col md:flex-row h-[600px] bg-base-100 rounded-lg overflow-hidden border border-base-200">
              <!-- Sidebar List -->
              <div class="w-full md:w-64 bg-base-50 border-r border-base-200 flex flex-col">
                  <div class="p-4 border-b border-base-200 flex justify-between items-center">
                      <h3 class="font-bold text-xs uppercase opacity-60 tracking-wider">Pages</h3>
                      <button class="btn btn-xs btn-ghost btn-square" (click)="addWikiSection()">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                      </button>
                  </div>
                  <ul class="menu p-2 w-full overflow-y-auto flex-1">
                      @for(section of p.wiki; track section.id) {
                          <li>
                              <a (click)="selectWikiSection(section.id)" [class.active]="currentWikiSection()?.id === section.id" class="rounded-md text-sm my-0.5">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                  <span class="truncate">{{ section.title }}</span>
                              </a>
                          </li>
                      } @empty {
                          <li class="text-xs opacity-50 p-2 text-center">No pages yet.</li>
                      }
                  </ul>
              </div>

              <!-- Main Content -->
              <div class="flex-1 flex flex-col min-w-0 bg-base-100">
                  @if(currentWikiSection(); as section) {
                      <div class="p-8 flex-1 overflow-y-auto">
                          @if(isEditingWiki()) {
                              <div class="form-control mb-4">
                                  <input type="text" [ngModel]="wikiEditTitle()" (ngModelChange)="wikiEditTitle.set($event)" class="input input-lg font-bold text-2xl px-0 border-0 focus:outline-none focus:border-b focus:border-base-300 bg-transparent placeholder:opacity-30 rounded-none h-auto pb-2" placeholder="Page Title">
                              </div>
                              <textarea [ngModel]="wikiEditContent()" (ngModelChange)="wikiEditContent.set($event)" class="textarea textarea-lg w-full h-[400px] font-mono text-sm leading-relaxed resize-none focus:outline-none p-0 bg-transparent placeholder:opacity-30 border-0" placeholder="# Write in markdown..."></textarea>
                          } @else {
                              <h1 class="text-3xl font-bold mb-6 pb-4 border-b border-base-100">{{ section.title }}</h1>
                              <div class="prose max-w-none prose-sm prose-headings:font-bold prose-p:text-base-content/80">
                                  <p class="whitespace-pre-wrap leading-relaxed">{{ section.content }}</p>
                              </div>
                              <div class="mt-12 pt-4 border-t border-base-100 text-xs opacity-40 font-mono">Last updated: {{ section.lastUpdated | date:'medium' }}</div>
                          }
                      </div>
                      
                      <!-- Toolbar -->
                      <div class="p-4 border-t border-base-200 flex justify-end gap-2 bg-base-50/50">
                          @if(isEditingWiki()) {
                              <button class="btn btn-sm btn-ghost" (click)="isEditingWiki.set(false)">Cancel</button>
                              <button class="btn btn-sm btn-neutral" (click)="saveWikiSection()">Save Page</button>
                          } @else {
                              <button class="btn btn-sm btn-ghost text-error" (click)="deleteWikiSection()">Delete</button>
                              <button class="btn btn-sm btn-outline border-base-300" (click)="startEditingWiki(section)">Edit Page</button>
                          }
                      </div>
                  } @else {
                      <div class="flex-1 flex flex-col items-center justify-center opacity-40">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                          <p>Select a page or create a new one.</p>
                          <button class="btn btn-neutral btn-sm mt-4" (click)="addWikiSection()">Create Page</button>
                      </div>
                  }
              </div>
          </div>
      }

      <!-- TAB: TASKS (Classic Kanban) -->
      @if(activeTab() === 'tasks') {
          <div class="flex flex-col h-full">
              <!-- Filter Bar & Actions -->
              <div class="flex flex-wrap justify-between items-center mb-4 gap-4 p-3 bg-base-50 rounded-lg border border-base-200">
                  <div class="flex items-center gap-2 flex-1">
                      <input type="text" [ngModel]="taskSearch()" (ngModelChange)="taskSearch.set($event)" placeholder="Search tasks..." class="input input-sm input-bordered w-full max-w-xs bg-base-100">
                      
                      <select [ngModel]="taskFilterAssignee()" (ngModelChange)="taskFilterAssignee.set($any($event))" class="select select-sm select-bordered w-full max-w-[150px] bg-base-100">
                          <option [ngValue]="null">All Assignees</option>
                          @for(m of regularMembers(); track m.id) {
                              <option [ngValue]="m.id">{{ m.name }}</option>
                          }
                      </select>

                      <select [ngModel]="taskFilterPriority()" (ngModelChange)="taskFilterPriority.set($event)" class="select select-sm select-bordered w-full max-w-[120px] bg-base-100">
                          <option value="All">Priority</option>
                          <option value="High">High</option>
                          <option value="Medium">Medium</option>
                          <option value="Low">Low</option>
                      </select>
                  </div>
                  <button class="btn btn-neutral btn-sm" (click)="openAddTaskModal()">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                      Add Task
                  </button>
              </div>

              <!-- Kanban Board -->
              <div class="flex gap-4 overflow-x-auto pb-4 h-[calc(100vh-18rem)] min-h-[500px] items-stretch">
                  @for(column of kanbanColumns(); track column.title) {
                      <!-- Classic Column -->
                      <div class="flex flex-col flex-1 min-w-[300px] h-full bg-base-50/50 rounded-lg border border-base-200"
                           (dragover)="onDragOver($event)" 
                           (drop)="onTaskDrop($event, $any(column.status))">
                          
                          <!-- Header -->
                          <div class="p-3 px-4 flex justify-between items-center border-b border-base-200 shrink-0">
                              <div class="flex items-center gap-2">
                                  <h3 class="font-bold text-xs uppercase tracking-wider opacity-60">{{ column.title }}</h3>
                                  <span class="badge badge-sm border-base-200 bg-base-100 font-mono text-xs">{{ column.tasks.length }}</span>
                              </div>
                              @if(column.status === 'To Do') {
                                  <button class="btn btn-xs btn-ghost btn-square opacity-60 hover:opacity-100" (click)="openAddTaskModal()">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                  </button>
                              }
                          </div>
                          
                          <!-- Task List -->
                          <div class="flex-1 flex flex-col gap-3 pt-3 p-2 overflow-y-auto custom-scrollbar">
                              @for(task of column.tasks; track task.id) {
                                  <div class="card bg-base-100 shadow-sm border border-base-200 p-4 cursor-grab hover:border-base-300 transition-all group shrink-0 relative"
                                       draggable="true" 
                                       (dragstart)="onTaskDragStart($event, task)" 
                                       (drop)="onTaskDrop($event, $any(column.status), task)"
                                       (click)="openEditTaskModal(task)">
                                      
                                      <div class="flex justify-between items-start mb-2 pointer-events-none">
                                          <div class="badge badge-xs text-[10px] font-bold h-5 px-1.5 border-none" [class]="getPriorityBadgeClass(task.priority)">{{ task.priority }}</div>
                                          @if(task.estimatedDays) { <span class="text-[10px] font-bold opacity-40 font-mono">{{ task.estimatedDays }}d</span> }
                                      </div>
                                      
                                      <div class="text-sm font-medium leading-snug text-base-content mb-3 pointer-events-none">{{ task.title }}</div>
                                      
                                      <div class="flex items-center justify-between border-t border-base-100 pt-3 mt-auto pointer-events-none">
                                          @if(getMember(task.assignedMemberId); as m) {
                                              <div class="flex items-center gap-2">
                                                  <div class="avatar"><div class="w-6 h-6 rounded-full ring-1 ring-base-200"><img [src]="m.avatarUrl"></div></div>
                                                  <span class="text-[10px] font-bold uppercase tracking-wide opacity-50 truncate max-w-[80px]">{{ m.name.split(' ')[0] }}</span>
                                              </div>
                                          } @else { <span class="text-xs opacity-40 italic">Unassigned</span> }
                                      </div>
                                  </div>
                              }
                              
                              <!-- Empty State -->
                              @if(column.tasks.length === 0) {
                                  <div class="flex-1 flex items-center justify-center opacity-20 border-2 border-dashed border-base-200 m-2 rounded-lg min-h-[100px]">
                                      <span class="text-xs font-bold uppercase tracking-wider">Drop Here</span>
                                  </div>
                              }
                          </div>
                      </div>
                  }
              </div>
          </div>
      }

      <!-- TAB: FILES -->
      @if(activeTab() === 'files') {
          <div class="min-h-[400px]">
              <div class="p-4 border-b border-base-200 flex justify-between items-center gap-4 bg-base-50/30 rounded-t-lg">
                  <input type="text" placeholder="Search files..." [ngModel]="fileSearch()" (ngModelChange)="fileSearch.set($event)" class="input input-bordered input-sm w-full max-w-xs bg-base-100">
                  <div class="flex gap-2">
                      <button class="btn btn-neutral btn-sm" (click)="triggerFileUpload(fileInput)">@if(isUploading()) { <span class="loading loading-spinner loading-xs"></span> } Upload</button>
                      <input #fileInput type="file" class="hidden" (change)="onFileSelected($event)">
                  </div>
              </div>
              <div class="overflow-x-auto">
                  <table class="table">
                      <thead class="text-xs uppercase opacity-60 bg-base-50/50"><tr><th class="w-12"></th><th>Name</th><th>Type</th><th>Size</th><th>Uploaded By</th><th>Date</th></tr></thead>
                      <tbody>
                          @for(file of projectFiles(); track file.id) {
                              <tr class="hover:bg-base-50 group">
                                  <td class="pl-4"><div class="w-8 h-8 rounded flex items-center justify-center text-[10px] font-bold uppercase tracking-wider bg-base-200 text-base-content/70">{{ file.type.slice(0,3) }}</div></td>
                                  <td class="font-medium text-sm">{{ file.name }}</td>
                                  <td class="text-xs opacity-60 uppercase">{{ file.type }}</td>
                                  <td class="text-xs opacity-60 font-mono">{{ file.size }}</td>
                                  <td>@if(getMember(file.uploadedBy); as m) { <div class="flex items-center gap-2"><div class="avatar"><div class="w-5 rounded-full"><img [src]="m.avatarUrl"></div></div><span class="text-xs">{{ m.name }}</span></div> }</td>
                                  <td class="text-xs opacity-60">{{ file.uploadedAt | date:'mediumDate' }}</td>
                              </tr>
                          } @empty { <tr><td colspan="6" class="text-center py-12 opacity-50 text-sm">No files uploaded.</td></tr> }
                      </tbody>
                  </table>
              </div>
          </div>
      }

      <!-- TAB: TEAM -->
      @if(activeTab() === 'team') {
          <div class="overflow-y-auto pr-2">
              <div class="flex justify-between items-center mb-6">
                  <div>
                      <h3 class="font-bold text-sm uppercase tracking-wider opacity-60">Allocation</h3>
                      <p class="text-sm opacity-60 mt-1">Manage project members and specific rates.</p>
                  </div>
                  <button class="btn btn-neutral btn-sm" (click)="openAddMemberModal()">Add Member</button>
              </div>
              
              <!-- Founders & Admins Section -->
              <div class="mb-8">
                  <h4 class="font-bold text-xs uppercase opacity-40 mb-3 pl-2 tracking-widest">Founders & Admins</h4>
                  <div class="overflow-x-auto border border-base-200 rounded-lg">
                      <table class="table">
                          <thead class="bg-base-50/50 text-xs uppercase opacity-60"><tr><th>Member</th><th>Role</th><th>Status</th></tr></thead>
                          <tbody>
                              @for(m of founderMembers(); track m.id) {
                                  <tr class="hover:bg-base-50">
                                      <td>
                                          <div class="flex items-center gap-3">
                                              <div class="avatar"><div class="w-8 rounded-full ring-1 ring-base-200"><img [src]="m.avatarUrl"></div></div>
                                              <div class="font-bold text-sm">{{ m.name }}</div>
                                          </div>
                                      </td>
                                      <td class="text-xs opacity-70">{{ m.role }}</td>
                                      <td><span class="badge badge-ghost badge-sm text-xs">Owner</span></td>
                                  </tr>
                              } @empty {
                                  <tr><td colspan="3" class="text-center opacity-40 italic py-4 text-xs">No founders assigned directly.</td></tr>
                              }
                          </tbody>
                      </table>
                  </div>
              </div>

              <!-- Team Members Section -->
              <div>
                  <h4 class="font-bold text-xs uppercase opacity-40 mb-3 pl-2 tracking-widest">Team Members</h4>
                  <div class="overflow-x-auto border border-base-200 rounded-lg">
                      <table class="table">
                          <thead class="bg-base-50/50 text-xs uppercase opacity-60"><tr><th>Member</th><th>Role</th><th>Payment Type</th><th>Project Rate</th><th>Actions</th></tr></thead>
                          <tbody>
                              @for(m of regularMembers(); track m.id) {
                                  <tr>
                                      <td>
                                          <div class="flex items-center gap-3">
                                              <div class="avatar"><div class="w-8 rounded-full ring-1 ring-base-200"><img [src]="m.avatarUrl"></div></div>
                                              <div class="font-bold text-sm">{{ m.name }}</div>
                                          </div>
                                      </td>
                                      <td class="text-xs opacity-70">{{ m.role }}</td>
                                      <td>
                                          <span class="badge badge-sm border-base-300 bg-base-100 font-normal">
                                              {{ memberPaymentTypes()[m.id] === 'fixed' ? 'Fixed Fee' : 'Hourly' }}
                                          </span>
                                      </td>
                                      <td>
                                          <label class="input-group input-group-sm">
                                              <span class="bg-base-200 text-xs">$</span>
                                              <input type="number" class="input input-bordered input-sm w-20 bg-base-100 text-right" [ngModel]="memberRates()[m.id] ?? m.defaultHourlyRate" (ngModelChange)="updateRate(m.id, +$event)">
                                          </label>
                                      </td>
                                      <td><button class="btn btn-ghost btn-xs text-error hover:bg-error/10" (click)="removeMemberFromProject(m.id)">Remove</button></td>
                                  </tr>
                              } @empty {
                                  <tr><td colspan="5" class="text-center opacity-40 italic py-4 text-xs">No team members assigned.</td></tr>
                              }
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      }
  </div>
</div>
}

<!-- Modals -->
@if(isTaskModalOpen()) {
    <app-task-modal [taskToEdit]="taskToEdit()" [prefilledContext]="taskModalContext()" (close)="closeTaskModal()" (saved)="saveChanges()"></app-task-modal>
}

@if(isPaymentModalOpen()) {
    <app-payment-modal 
        [prefilledMemberId]="payMemberId()"
        [prefilledAmount]="payAmount()"
        [prefilledProjectId]="project()?.id || null"
        [prefilledRef]="'Payment for ' + (project()?.name || 'Project')"
        (close)="closePaymentModal()" 
        (saved)="saveChanges()">
    </app-payment-modal>
}

@if(showAddMemberModal()) {
    <dialog class="modal modal-open">
        <div class="modal-box w-11/12 max-w-lg border border-base-200 shadow-2xl rounded-xl">
            <h3 class="font-bold text-lg mb-4">Add Team Member</h3>
            
            <div class="bg-base-50 p-4 rounded-lg mb-4 border border-base-200">
                <h4 class="text-xs font-bold uppercase opacity-60 mb-2">Default Payment Settings</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label py-1"><span class="label-text text-xs opacity-70">Payment Type</span></label>
                        <select [ngModel]="tempMemberPaymentType()" (ngModelChange)="tempMemberPaymentType.set($event)" class="select select-bordered select-sm w-full bg-base-100">
                            <option value="hourly">Hourly Rate</option>
                            <option value="fixed">Fixed Fee</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label py-1"><span class="label-text text-xs opacity-70">Rate / Amount ($)</span></label>
                        <input type="number" [ngModel]="tempMemberRate()" (ngModelChange)="tempMemberRate.set(+$event)" class="input input-bordered input-sm w-full bg-base-100" min="0" placeholder="Default">
                    </div>
                </div>
                <div class="text-[10px] opacity-60 mt-2">Leave amount as 0 to use member's default hourly rate (if applicable).</div>
            </div>

            <div class="flex flex-col gap-2 max-h-[300px] overflow-y-auto">
                @for(member of paginatedAvailableMembers(); track member.id) {
                    <div class="flex items-center justify-between p-3 border border-base-200 rounded-lg hover:bg-base-50 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="avatar"><div class="w-8 rounded-full"><img [src]="member.avatarUrl"></div></div>
                            <div>
                                <div class="font-bold text-sm">{{ member.name }}</div>
                                <div class="text-xs opacity-50">{{ member.role }}</div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-neutral" (click)="addMemberToProject(member)">Add</button>
                    </div>
                } @empty { <div class="text-center opacity-50 py-4 text-sm">No available members to add.</div> }
            </div>
            <div class="modal-action"><button class="btn btn-ghost" (click)="showAddMemberModal.set(false)">Close</button></div>
        </div>
    </dialog>
}

@if(showSuccessToast()){
<div class="toast toast-top toast-center z-50">
  <div class="alert alert-success shadow-sm border border-success/20">
    <span>Project updated successfully.</span>
  </div>
</div>
}
