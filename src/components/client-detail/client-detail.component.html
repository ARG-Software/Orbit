
@if(client(); as c){
<div class="container mx-auto pb-8">
  
  <!-- Top Section: Header & Summary Stats -->
  <div class="mb-8">
      <!-- Header -->
      <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
        <div class="flex items-center gap-4">
            <a routerLink="/app/clients" class="btn btn-sm btn-square btn-ghost border border-base-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
            </a>
            
            <div class="flex items-center gap-4">
                <div class="avatar">
                    <div class="w-12 h-12 rounded-lg ring-1 ring-base-200">
                        <img [src]="c.logoUrl" alt="{{ c.name }} logo" class="object-cover">
                    </div>
                </div>
                <div>
                    <h1 class="text-2xl font-light tracking-tight">{{ c.name }}</h1>
                    <div class="flex items-center gap-3 text-sm opacity-60">
                        <span>{{ c.contact }}</span>
                        <span class="w-1 h-1 rounded-full bg-current opacity-50"></span>
                        <span class="uppercase text-[10px] font-bold tracking-wider">{{ c.status }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex gap-2">
            <button class="btn btn-sm btn-ghost" (click)="openEmailModal()" title="Send Email">
                Email
            </button>
            <button class="btn btn-sm btn-ghost" (click)="toggleStatus()">
                {{ c.status === 'Active' ? 'Pause' : 'Resume' }}
            </button>
            <button class="btn btn-sm btn-ghost text-error" (click)="deleteClient()">
                Delete
            </button>
        </div>
      </div>

      <!-- Summary Panel -->
      @let stats = clientStats();
      @if(stats) {
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="card bg-base-100 shadow-sm border border-base-200 rounded-lg p-5">
              <div class="flex justify-between items-start">
                  <span class="font-bold text-xs uppercase tracking-wider opacity-50">Total Revenue</span>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg>
              </div>
              <div class="mt-2 text-2xl font-light tracking-tight">{{ stats.totalRevenue | currency:'USD':'symbol':'1.0-0' }}</div>
          </div>
          
          <div class="card bg-base-100 shadow-sm border border-base-200 rounded-lg p-5">
              <div class="flex justify-between items-start">
                  <span class="font-bold text-xs uppercase tracking-wider opacity-50">Outstanding</span>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
              </div>
              <div class="mt-2 text-2xl font-light tracking-tight text-warning">{{ stats.outstandingAmount | currency:'USD':'symbol':'1.0-0' }}</div>
          </div>

          <div class="card bg-base-100 shadow-sm border border-base-200 rounded-lg p-5">
              <div class="flex justify-between items-start">
                  <span class="font-bold text-xs uppercase tracking-wider opacity-50">Active Projects</span>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 00-2-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
              </div>
              <div class="mt-2 text-2xl font-light tracking-tight">{{ stats.activeProjects }}</div>
          </div>

          <div class="card bg-base-100 shadow-sm border border-base-200 rounded-lg p-5">
              <div class="flex justify-between items-start">
                  <span class="font-bold text-xs uppercase tracking-wider opacity-50">Next Meeting</span>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
              </div>
              <div class="mt-2 text-2xl font-light tracking-tight">{{ stats.upcomingMeetings }}</div>
          </div>
      </div>
      }
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Left Column: Client Profile & Settings (1/3) -->
    <div class="lg:col-span-1 flex flex-col gap-6">
        <div class="card bg-base-100 shadow-sm border border-base-200 h-fit">
            <div class="card-body p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-sm uppercase opacity-50 tracking-wider">Client Profile</h2>
                    <button class="btn btn-xs btn-ghost border border-base-200" (click)="saveClientDetails()">Save</button>
                </div>
                
                <!-- Accordion Group -->
                <div class="join join-vertical w-full border border-base-200 rounded-lg">
                    
                    <!-- Section 1: Identity -->
                    <div class="collapse collapse-arrow join-item border-base-200 border-b">
                        <input type="radio" name="client-details-accordion" checked="checked" /> 
                        <div class="collapse-title text-sm font-medium">Identity</div>
                        <div class="collapse-content text-sm space-y-3 pt-2">
                            <div class="form-control">
                                <label class="label py-1 text-xs opacity-70">Name</label>
                                <input type="text" class="input input-bordered input-sm bg-base-100" [ngModel]="clientName()" (ngModelChange)="clientName.set($event)">
                            </div>
                            <div class="form-control">
                                <label class="label py-1 text-xs opacity-70">Status</label>
                                <select class="select select-bordered select-sm bg-base-100" [ngModel]="clientStatus()" (ngModelChange)="clientStatus.set($event)">
                                    <option value="Active">Active</option>
                                    <option value="Paused">Paused</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Contact -->
                    <div class="collapse collapse-arrow join-item border-base-200 border-b">
                        <input type="radio" name="client-details-accordion" /> 
                        <div class="collapse-title text-sm font-medium">Contact Information</div>
                        <div class="collapse-content text-sm space-y-3 pt-2">
                            <div class="form-control">
                                <label class="label py-1 text-xs opacity-70">Email</label>
                                <input type="email" class="input input-bordered input-sm bg-base-100" [ngModel]="clientContact()" (ngModelChange)="clientContact.set($event)">
                            </div>
                            <div class="form-control">
                                <label class="label py-1 text-xs opacity-70">Phone</label>
                                <input type="tel" class="input input-bordered input-sm bg-base-100" [ngModel]="clientPhone()" (ngModelChange)="clientPhone.set($event)">
                            </div>
                            <div class="form-control">
                                <label class="label py-1 text-xs opacity-70">Address</label>
                                <input type="text" class="input input-bordered input-sm bg-base-100" [ngModel]="clientAddress()" (ngModelChange)="clientAddress.set($event)">
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Financials -->
                    <div class="collapse collapse-arrow join-item border-base-200 border-b">
                        <input type="radio" name="client-details-accordion" /> 
                        <div class="collapse-title text-sm font-medium">Financial Settings</div>
                        <div class="collapse-content text-sm space-y-3 pt-2">
                            <div class="form-control">
                                <label class="label py-1 text-xs opacity-70">Tax Number</label>
                                <input type="text" class="input input-bordered input-sm bg-base-100" [ngModel]="clientTaxNumber()" (ngModelChange)="clientTaxNumber.set($event)">
                            </div>
                            <div class="form-control">
                                <label class="label py-1 text-xs opacity-70">Default Tax Rate (%)</label>
                                <input type="number" class="input input-bordered input-sm bg-base-100" [ngModel]="clientTaxRate()" (ngModelChange)="clientTaxRate.set(+$event)" step="0.1" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Section 4: Notes -->
                    <div class="collapse collapse-arrow join-item border-base-200">
                        <input type="radio" name="client-details-accordion" /> 
                        <div class="collapse-title text-sm font-medium">Notes</div>
                        <div class="collapse-content pt-2">
                            <textarea class="textarea textarea-bordered w-full h-32 text-sm bg-base-100" placeholder="Private client notes..." [ngModel]="clientNotes()" (ngModelChange)="clientNotes.set($event)"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Activity Feed (2/3) -->
    <div class="lg:col-span-2 flex flex-col gap-6">
        <div class="card bg-base-100 shadow-sm border border-base-200">
            <div class="card-body p-0">
                <!-- Tabs -->
                <div role="tablist" class="tabs tabs-bordered px-4">
                    <a role="tab" class="tab h-12" [class.tab-active]="activeTab() === 'projects'" (click)="activeTab.set('projects')">Projects</a>
                    <a role="tab" class="tab h-12" [class.tab-active]="activeTab() === 'invoices'" (click)="activeTab.set('invoices')">Invoices</a>
                    <a role="tab" class="tab h-12" [class.tab-active]="activeTab() === 'meetings'" (click)="activeTab.set('meetings')">Meetings</a>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    
                    <!-- Projects Tab -->
                    @if(activeTab() === 'projects') {
                        <div class="space-y-3">
                            @for(project of paginatedProjects(); track project.id){
                                <a [routerLink]="['/app/projects', project.id]" class="block border border-base-200 rounded-lg p-4 hover:bg-base-50 transition-all cursor-pointer group">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="font-bold text-sm group-hover:text-primary transition-colors">{{ project.name }}</h3>
                                            <div class="mt-1 flex items-center gap-2">
                                                <span class="badge badge-xs border-base-300 font-normal" [class.bg-base-200]="project.status !== 'Active'" [class.badge-neutral]="project.status === 'Active'">{{ project.status }}</span>
                                                <span class="text-xs opacity-50">{{ project.billingType | titlecase }}</span>
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center gap-4">
                                            <!-- Team Avatars -->
                                            <div class="avatar-group -space-x-3 rtl:space-x-reverse hidden sm:flex">
                                                @for(memberId of project.allocatedTeamMemberIds.slice(0, 4); track memberId){
                                                    @let member = getMemberById(memberId);
                                                    @if(member){
                                                        <div class="avatar border-base-100" title="{{ member.name }}">
                                                            <div class="w-8">
                                                                <img [src]="member.avatarUrl" [alt]="member.name" />
                                                            </div>
                                                        </div>
                                                    }
                                                }
                                            </div>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-30 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                                        </div>
                                    </div>
                                </a>
                            } @empty {
                                <div class="text-center py-10 opacity-50 text-sm">No projects found.</div>
                            }
                        </div>
                        
                        @if(projects().length > itemsPerPage()){
                            <div class="flex justify-center mt-6">
                            <app-pagination 
                                [currentPage]="currentPage()"
                                [totalItems]="projects().length"
                                [itemsPerPage]="itemsPerPage()"
                                (pageChange)="onPageChange($event)">
                            </app-pagination>
                            </div>
                        }
                    }

                    <!-- Invoices Tab -->
                    @if(activeTab() === 'invoices') {
                        <div class="overflow-x-auto">
                            <table class="table table-sm">
                                <thead class="bg-base-50 text-base-content/70">
                                    <tr>
                                        <th>Number</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th class="text-right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for(inv of clientInvoicesList(); track inv.id) {
                                        <tr class="hover:bg-base-50">
                                            <td class="font-mono font-medium text-xs">{{ inv.invoiceNumber }}</td>
                                            <td>{{ inv.invoiceDate | date:'mediumDate' }}</td>
                                            <td>
                                                <span class="badge badge-sm badge-ghost font-normal" [class.text-success]="inv.status === 'Paid'" [class.text-warning]="inv.status === 'Pending'" [class.text-error]="inv.status === 'Overdue'">
                                                    {{ inv.status }}
                                                </span>
                                            </td>
                                            <td class="text-right font-medium">{{ inv.total | currency:'USD':'symbol':'1.2-2' }}</td>
                                        </tr>
                                    } @empty {
                                        <tr><td colspan="4" class="text-center py-8 opacity-50 text-sm">No invoices yet.</td></tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }

                    <!-- Meetings Tab -->
                    @if(activeTab() === 'meetings') {
                        <ul class="space-y-2">
                            @for(meeting of clientMeetingsList(); track meeting.id) {
                                <li class="flex items-center justify-between p-3 bg-base-100 rounded-lg border border-base-200">
                                    <div class="flex items-center gap-4">
                                        <div class="bg-base-50 p-2 rounded text-center border border-base-200 min-w-[50px]">
                                            <div class="text-[10px] font-bold uppercase opacity-60">{{ meeting.startTime | date:'MMM' }}</div>
                                            <div class="text-lg font-light leading-none">{{ meeting.startTime | date:'dd' }}</div>
                                        </div>
                                        <div>
                                            <div class="font-bold text-sm">{{ meeting.title }}</div>
                                            <div class="text-xs opacity-60">{{ meeting.startTime | date:'shortTime' }} • {{ meeting.platform }}</div>
                                        </div>
                                    </div>
                                    <div class="badge badge-ghost badge-sm text-xs font-normal">{{ meeting.status }}</div>
                                </li>
                            } @empty {
                                <div class="text-center py-8 opacity-50 text-sm">No meetings scheduled.</div>
                            }
                        </ul>
                    }
                </div>
            </div>
        </div>
    </div>
  </div>
</div>
} @else {
    <div class="flex justify-center items-center h-64">
        <span class="loading loading-spinner loading-lg opacity-20"></span>
    </div>
}

<!-- Email Modal -->
@if(isEmailModalOpen()){
  <dialog class="modal modal-open">
    <div class="modal-box shadow-2xl border border-base-200 rounded-xl">
      <button (click)="closeEmailModal()" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      <h3 class="font-bold text-lg mb-1">Send Email</h3>
      <p class="text-sm opacity-70 mb-6">To: <span class="font-semibold">{{ client()?.name }}</span> ({{ client()?.contact }})</p>
      
      <form (ngSubmit)="sendEmail()" class="space-y-4">
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Subject</span></label>
          <input type="text" [ngModel]="emailSubject()" (ngModelChange)="emailSubject.set($event)" name="subject" required class="input input-bordered w-full focus:input-primary" placeholder="e.g. Project Update">
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Message</span></label>
          <textarea [ngModel]="emailBody()" (ngModelChange)="emailBody.set($event)" name="body" required class="textarea textarea-bordered h-32 focus:textarea-primary" placeholder="Write your message here..."></textarea>
        </div>
        <div class="modal-action mt-6">
          <button type="button" (click)="closeEmailModal()" class="btn btn-ghost">Cancel</button>
          <button type="submit" class="btn btn-neutral px-6">
            Send Message
          </button>
        </div>
      </form>
    </div>
  </dialog>
}

<!-- Success Toast -->
@if(showSuccessToast()){
<div class="toast toast-top toast-center">
  <div class="alert alert-success shadow-sm border border-success/20">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
    <span>{{ toastMessage() }}</span>
  </div>
</div>
}
