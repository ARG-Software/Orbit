
<div class="w-full pb-12">
  
  <!-- Quick Actions Toolbar -->
  <div class="flex flex-wrap items-center gap-3 mb-6 animate-fade-in-down">
      <button class="btn btn-neutral btn-sm gap-2" (click)="isTaskModalOpen.set(true)">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
          New Task
      </button>
      <button class="btn btn-ghost border border-base-300 btn-sm gap-2 bg-base-100" (click)="isProjectModalOpen.set(true)">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 00-2-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
          New Project
      </button>
      <button class="btn btn-ghost border border-base-300 btn-sm gap-2 bg-base-100" (click)="openExpenseModal()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg>
          Record Expense
      </button>
      <div class="ml-auto text-xs opacity-40 hidden sm:block font-medium uppercase tracking-widest">
          Executive View
      </div>
  </div>

  <!-- BENTO GRID LAYOUT (Draggable) -->
  <div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-4 grid-flow-dense auto-rows-[minmax(140px,auto)]">

      @for (widget of widgets(); track widget; let i = $index) {
          <div [class]="getWidgetClass(widget)"
               draggable="true" 
               (dragstart)="onDragStart($event, i)" 
               (dragover)="onDragOver($event)" 
               (drop)="onDrop($event, i)"
               class="cursor-grab active:cursor-grabbing transition-transform duration-200 hover:scale-[1.005]">
               
               @switch (widget) {
                   @case ('welcome') {
                        <!-- TILE 1: WELCOME CLOCK (Minimalist) -->
                        <div class="card bg-base-100 text-base-content shadow-sm border border-base-200 rounded-lg p-6 relative overflow-hidden h-full">
                            <div class="relative z-10 flex flex-col justify-between h-full">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-xs font-bold opacity-40 uppercase tracking-widest">{{ currentTime() | date:'EEEE, dd MMMM' }}</h3>
                                        <h1 class="text-4xl font-light tracking-tight mt-2">
                                            {{ currentTime() | date:'HH:mm' }}
                                        </h1>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-medium">{{ user()?.name?.split(' ')?.[0] }}</div>
                                        <div class="text-xs font-medium opacity-40">{{ greeting() }}</div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-2 mt-4">
                                    <div class="badge badge-sm badge-ghost gap-2 pl-1 pr-3 bg-base-200/50 border-base-300">
                                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
                                        <span class="text-[10px] uppercase font-bold tracking-wide text-base-content/60">{{ translationService.translate('Online') }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                   }

                   @case ('activity') {
                        <!-- TILE 2: HOURS LOGGED (Grayscale) -->
                        <div class="card bg-base-100 text-base-content shadow-sm border border-base-200 rounded-lg p-5 relative overflow-hidden flex flex-col justify-between h-full group">
                            <div class="flex justify-between items-start w-full z-10">
                                <span class="font-bold text-xs uppercase tracking-wider opacity-50">{{ translationService.translate('Activity') }}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-30" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                            </div>
                            
                            <div class="flex items-end justify-between mt-2">
                                <div>
                                    <div class="text-3xl font-light tracking-tight">{{ weeklyHoursLogged() | number:'1.0-0' }}<span class="text-lg opacity-40 font-normal ml-0.5">h</span></div>
                                    <div class="text-[10px] font-medium opacity-40 mt-1">{{ translationService.translate('This Week') }}</div>
                                </div>
                                
                                <!-- Mini Graph -->
                                <div class="flex items-end gap-1 h-8 opacity-30">
                                    <div class="w-1.5 bg-current h-[30%] rounded-t-sm"></div>
                                    <div class="w-1.5 bg-current h-[60%] rounded-t-sm"></div>
                                    <div class="w-1.5 bg-current h-[40%] rounded-t-sm"></div>
                                    <div class="w-1.5 bg-current h-[80%] rounded-t-sm"></div>
                                    <div class="w-1.5 bg-current h-[50%] rounded-t-sm"></div>
                                </div>
                            </div>
                        </div>
                   }

                   @case ('revenue') {
                        <!-- TILE 3: REVENUE (Monochrome) -->
                        <div class="card bg-base-100 text-base-content shadow-sm border border-base-200 rounded-lg p-5 relative overflow-hidden flex flex-col justify-between h-full">
                            <div class="flex justify-between items-start">
                                <span class="font-bold text-xs uppercase tracking-wider opacity-50">{{ translationService.translate('Revenue') }}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg>
                            </div>
                            
                            <div class="mt-2">
                                <div class="text-3xl font-light tracking-tight">{{ weeklyFinancials().revenue | currency:'USD':'symbol':'1.0-0' }}</div>
                                <div class="w-full bg-base-200 h-1 mt-3 rounded-full overflow-hidden">
                                    <div class="bg-base-content h-full w-[65%] opacity-80"></div>
                                </div>
                            </div>
                        </div>
                   }

                   @case ('status') {
                        <!-- TILE 4: STATUS GAUGE (Sober) -->
                        <div class="card bg-base-100 text-base-content shadow-sm border border-base-200 rounded-lg p-6 flex flex-col items-center relative overflow-hidden h-full">
                            <div class="w-full flex justify-between items-center mb-4">
                                <span class="font-bold text-xs uppercase tracking-wider opacity-50">{{ translationService.translate('Status') }}</span>
                                <div class="badge badge-sm badge-ghost border-base-300 font-medium text-[10px]">{{ weeklyProjectsCount() }} {{ translationService.translate('Active') }}</div>
                            </div>

                            <!-- Large Gauge (Neutral) -->
                            <div class="relative w-40 h-40 my-auto">
                                <svg viewBox="0 0 200 200" class="w-full h-full transform -rotate-90">
                                    <circle cx="100" cy="100" r="85" fill="none" class="stroke-base-200" stroke-width="12" stroke-linecap="round" />
                                    <circle cx="100" cy="100" r="85" fill="none" stroke="currentColor" stroke-width="12" stroke-linecap="round" 
                                            stroke-dasharray="534" 
                                            [attr.stroke-dashoffset]="534 - (534 * 0.7)" 
                                            class="text-base-content opacity-80" />
                                </svg>
                                
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span class="text-3xl font-light">{{ allProjects().length }}</span>
                                    <span class="text-[10px] uppercase font-bold opacity-40">{{ translationService.translate('Total') }}</span>
                                </div>
                            </div>
                        </div>
                   }

                   @case ('activeProjects') {
                        <!-- TILE 5: WORKSPACE (Card Style) -->
                        <div class="card bg-base-100 text-base-content shadow-sm border border-base-200 rounded-lg p-5 cursor-pointer hover:border-base-300 transition-all group h-full" routerLink="/app/projects">
                            <div class="flex justify-between items-start mb-4">
                                <span class="font-bold text-xs uppercase tracking-wider opacity-50">{{ translationService.translate('Workspace') }}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-30 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4-4 2 2 0 014 4z" /></svg>
                            </div>
                            
                            <div class="mt-auto">
                                <div class="text-2xl font-light mb-1">{{ weeklyProjectsCount() }}</div>
                                <div class="text-[10px] opacity-50 font-medium">Active Projects</div>
                                <div class="w-full bg-base-200 h-1 mt-3 rounded-full overflow-hidden">
                                    <div class="bg-base-content h-full w-[40%] opacity-40"></div>
                                </div>
                            </div>
                        </div>
                   }

                   @case ('nextMeeting') {
                        <!-- TILE 6: NEXT MEETING (Clean List) -->
                        <div class="card bg-base-100 text-base-content shadow-sm border border-base-200 rounded-lg p-5 flex flex-row items-center gap-5 relative overflow-hidden h-full">
                            @let meetings = upcomingMeetings();
                            @if(meetings.length > 0) {
                                @let next = meetings[0];
                                <div class="w-12 h-12 rounded border border-base-200 bg-base-50 flex flex-col items-center justify-center shrink-0">
                                    <span class="text-[9px] font-bold uppercase opacity-50">{{ next.startTime | date:'MMM' }}</span>
                                    <span class="text-lg font-bold leading-none">{{ next.startTime | date:'dd' }}</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] font-bold uppercase tracking-wider opacity-40">{{ translationService.translate('Next Up') }}</span>
                                        <span class="w-1 h-1 rounded-full bg-base-content opacity-20"></span>
                                        <span class="text-[10px] font-medium opacity-60">{{ next.platform }}</span>
                                    </div>
                                    <h3 class="font-medium text-sm truncate">{{ next.title }}</h3>
                                    <p class="text-xs opacity-50 truncate mt-0.5">{{ next.startTime | date:'shortTime' }} • {{ next.clientName }}</p>
                                </div>
                                <div class="pr-1">
                                    <a [href]="next.link" target="_blank" class="btn btn-square btn-sm btn-ghost border border-base-200 hover:bg-base-200 hover:border-base-300">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-60" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" /></svg>
                                    </a>
                                </div>
                            } @else {
                                <div class="flex-1 flex items-center justify-center gap-3 opacity-40">
                                    <span class="font-medium text-sm">{{ translationService.translate('No meetings today') }}</span>
                                </div>
                            }
                        </div>
                   }

                   @case ('ai') {
                        <!-- TILE 7: AI ASSISTANT (Professional) -->
                        <div class="card bg-base-100 text-base-content shadow-sm border border-base-200 rounded-lg p-5 cursor-pointer hover:border-base-300 transition-all group h-full" (click)="planMyDay()">
                            <div class="relative z-10 flex flex-col h-full justify-center items-center text-center gap-3">
                                <div class="w-10 h-10 rounded-full border border-base-200 bg-base-50 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                    @if(isAiLoading()) {
                                        <span class="loading loading-spinner loading-xs opacity-50"></span>
                                    } @else {
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                    }
                                </div>
                                <div>
                                    <div class="font-bold text-sm">{{ translationService.translate('AI Assistant') }}</div>
                                    <div class="text-[10px] opacity-50 uppercase tracking-wide mt-1">{{ translationService.translate('Generate Plan') }}</div>
                                </div>
                            </div>
                        </div>
                   }
               }
          </div>
      }

  </div>

  <!-- AI Result Modal (Floating) -->
  @if(aiSuggestion()) {
      <div class="fixed bottom-6 right-6 z-50 max-w-sm w-full animate-bounce-in">
          <div class="bg-base-100 shadow-2xl border border-base-300 p-6 rounded-xl relative overflow-hidden">
              <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 opacity-50 hover:opacity-100" (click)="aiSuggestion.set(null)">✕</button>
              <div class="flex items-start gap-4">
                  <div class="w-8 h-8 rounded-full border border-base-200 bg-base-50 flex items-center justify-center shrink-0">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                  </div>
                  <div>
                      <h3 class="font-bold text-sm uppercase tracking-wide opacity-50 mb-2">AI Insight</h3>
                      <div class="text-sm leading-relaxed whitespace-pre-line">{{ aiSuggestion() }}</div>
                  </div>
              </div>
          </div>
      </div>
  }
</div>

<!-- Modals -->
@if(isTaskModalOpen()) { <app-task-modal (close)="isTaskModalOpen.set(false)"></app-task-modal> }
@if(isProjectModalOpen()) { <app-project-modal (close)="isProjectModalOpen.set(false)"></app-project-modal> }
@if(isExpenseModalOpen()) {
    <dialog class="modal modal-open">
        <div class="modal-box shadow-2xl border border-base-200 rounded-xl p-8">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-4 top-4" (click)="isExpenseModalOpen.set(false)">✕</button>
            <h3 class="font-bold text-xl mb-6">Quick Expense</h3>
            <div class="flex flex-col gap-4">
                <div class="form-control">
                    <label class="label"><span class="label-text font-medium">Amount ($)</span></label>
                    <input type="number" [ngModel]="newExpenseAmount()" (ngModelChange)="newExpenseAmount.set(+$event)" class="input input-lg input-bordered w-full font-mono font-bold text-xl bg-base-100" placeholder="0.00" min="0">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-medium">Recipient</span></label>
                    <input type="text" [ngModel]="newExpenseRecipient()" (ngModelChange)="newExpenseRecipient.set($event)" class="input input-bordered w-full bg-base-100" placeholder="e.g. Vendor Name">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-medium">Description</span></label>
                    <textarea [ngModel]="newExpenseDescription()" (ngModelChange)="newExpenseDescription.set($event)" class="textarea textarea-bordered h-24 resize-none bg-base-100" placeholder="What is this for?"></textarea>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-neutral btn-block rounded-lg h-12" (click)="saveExpense()" [disabled]="!newExpenseAmount() || !newExpenseRecipient()">Record Expense</button>
            </div>
        </div>
    </dialog>
}
